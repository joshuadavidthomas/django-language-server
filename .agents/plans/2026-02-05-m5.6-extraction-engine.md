# M5: Extraction Engine - Phase 6

> **Parent document**: [M5: Extraction Engine Overview](2026-02-05-m5-extraction-engine.md)

---

## Phase 6: Implement Filter Arity Extraction

### Changes Required:

#### 1. Implement filters.rs
**File**: `crates/djls-extraction/src/filters.rs`

```rust
use ruff_python_ast::Mod;
use ruff_python_ast::Stmt;

use crate::parser::ParsedModule;
use crate::registry::RegistrationInfo;
use crate::types::FilterArity;
use crate::ExtractionError;

pub fn extract_filter_arity(
    parsed: &ParsedModule,
    registration: &RegistrationInfo,
) -> Result<FilterArity, ExtractionError> {
    let Mod::Module(module) = parsed.ast() else {
        return Ok(FilterArity::Unknown);
    };
    
    let func_def = module.body.iter().find_map(|stmt| {
        if let Stmt::FunctionDef(fd) = stmt {
            if fd.name.as_str() == registration.function_name {
                return Some(fd);
            }
        }
        None
    });
    
    let Some(func_def) = func_def else {
        return Ok(FilterArity::Unknown);
    };
    
    let params = &func_def.parameters;
    let positional_count = params.args.len() + params.posonlyargs.len();
    
    if params.vararg.is_some() {
        return Ok(FilterArity::Unknown);
    }
    
    match positional_count {
        0 | 1 => Ok(FilterArity::None),
        2 => {
            let has_default = !params.defaults.is_empty();
            if has_default {
                Ok(FilterArity::Optional)
            } else {
                Ok(FilterArity::Required)
            }
        }
        _ => Ok(FilterArity::Unknown),
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use crate::extract_rules;

    #[test]
    fn test_filter_no_arg() {
        let source = r#"
@register.filter
def title(value):
    return value.title()
"#;
        let result = extract_rules(source).unwrap();
        assert_eq!(result.filters[0].arity, FilterArity::None);
    }

    #[test]
    fn test_filter_required_arg() {
        let source = r#"
@register.filter
def truncatewords(value, arg):
    return value[:int(arg)]
"#;
        let result = extract_rules(source).unwrap();
        assert_eq!(result.filters[0].arity, FilterArity::Required);
    }

    #[test]
    fn test_filter_optional_arg() {
        let source = r#"
@register.filter
def default(value, arg=""):
    return value or arg
"#;
        let result = extract_rules(source).unwrap();
        assert_eq!(result.filters[0].arity, FilterArity::Optional);
    }
}
```

### Success Criteria:
- [ ] Filter tests pass: `cargo test -p djls-extraction filters`

---

