# M3: Load Scoping - Phase 6

> **Parent document**: [M3: Load Scoping Overview](2026-02-05-m3-load-scoping.md)

---

## Phase 6: Library Completions Enhancement

### Overview
Update `{% load %}` completions to show available libraries (not loaded yet) and handle completion behavior correctly.

### Changes Required:

#### 1. Update generate_library_completions
**File**: `crates/djls-ide/src/completions.rs`
**Changes**: Use libraries from inventory, show what's NOT yet loaded

```rust
/// Generate completions for library names (for {% load %} tag)
fn generate_library_completions(
    partial: &str,
    closing: &ClosingBrace,
    template_tags: Option<&TemplateTags>,
    loaded_libraries: Option<&LoadedLibraries>,
    cursor_byte_offset: u32,
) -> Vec<ls_types::CompletionItem> {
    let Some(tags) = template_tags else {
        return Vec::new();
    };

    // Get all available library names from inventory
    let mut library_entries: Vec<_> = tags.libraries()
        .iter()
        .filter(|(load_name, _)| load_name.starts_with(partial))
        .collect();
    library_entries.sort_by_key(|(load_name, _)| load_name.as_str());

    // Get already-loaded libraries to deprioritize them
    let already_loaded = loaded_libraries
        .map(|l| l.libraries_before(cursor_byte_offset))
        .unwrap_or_default();

    let mut completions = Vec::new();

    for (load_name, module_path) in library_entries {
        let is_already_loaded = already_loaded.contains(load_name);
        
        let mut insert_text = load_name.clone();

        // Add closing if needed
        match closing {
            ClosingBrace::None => insert_text.push_str(" %}"),
            ClosingBrace::PartialClose => insert_text.push_str(" %"),
            ClosingBrace::FullClose => {}
        }

        completions.push(ls_types::CompletionItem {
            label: load_name.clone(),
            kind: Some(ls_types::CompletionItemKind::MODULE),
            detail: Some(if is_already_loaded {
                format!("Already loaded ({})", module_path)
            } else {
                format!("Django template library ({})", module_path)
            }),
            insert_text: Some(insert_text),
            insert_text_format: Some(ls_types::InsertTextFormat::PLAIN_TEXT),
            filter_text: Some(load_name.clone()),
            // Deprioritize already-loaded libraries
            sort_text: Some(if is_already_loaded {
                format!("1_{}", load_name)
            } else {
                format!("0_{}", load_name)
            }),
            // Mark deprecated if already loaded (shows strikethrough in some editors)
            deprecated: Some(is_already_loaded),
            ..Default::default()
        });
    }

    completions
}
```

#### 2. Update Call Site
**File**: `crates/djls-ide/src/completions.rs`
**Changes**: Pass loaded_libraries to generate_library_completions

```rust
TemplateCompletionContext::LibraryName { partial, closing } => {
    generate_library_completions(
        partial,
        closing,
        template_tags,
        loaded_libraries,   // NEW
        cursor_byte_offset, // NEW
    )
}
```

### Success Criteria:

#### Automated Verification:
- [ ] Cargo build passes: `cargo build`
- [ ] All tests pass: `cargo test`

#### Manual Verification:
- [ ] `{% load %}` completions show all available libraries
- [ ] Already-loaded libraries are deprioritized/marked

---

